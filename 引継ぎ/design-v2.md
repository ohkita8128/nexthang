# あそボット 設計資料 v2

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                      LINE App                           │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                 │
│  │  Bot    │  │  LIFF   │  │ Push    │                 │
│  │ Message │  │  App    │  │ Notify  │                 │
│  └────┬────┘  └────┬────┘  └────┬────┘                 │
└───────┼────────────┼────────────┼───────────────────────┘
        │            │            │
        ▼            ▼            ▼
┌─────────────────────────────────────────────────────────┐
│                   Vercel (Next.js)                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │ Webhook │  │  LIFF   │  │  API    │  │  Cron   │   │
│  │  API    │  │  Pages  │  │ Routes  │  │  Job    │   │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘   │
└───────┼────────────┼────────────┼────────────┼─────────┘
        │            │            │            │
        ▼            ▼            ▼            ▼
┌─────────────────────────────────────────────────────────┐
│                    Supabase                             │
│  ┌──────────────────────────────────────────────────┐  │
│  │                  PostgreSQL                       │  │
│  │  users / groups / wishes / schedules / settings  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 画面フロー

```
ホーム (/liff)
├── 🔔 回答が必要
│   ├── → 参加確認ページ (/liff/wishes/[id]/confirm)
│   └── → 日程調整投票 (/liff/wishes/[id]/schedule/vote)
├── 📅 直近の予定
│   └── → 参加確認ページ
├── 🔥 人気の行きたい
│   └── → 行きたいリスト (/liff/wishes)
└── クイックアクション
    ├── → 行きたい追加 (/liff/wishes/new)
    └── → カレンダー (/liff/calendar)

行きたいリスト (/liff/wishes)
├── [興味あり] → 興味ありトグル
├── [参加確認に回答] → 参加確認ページ
├── [日程調整に回答] → 日程調整投票
├── [参加確認を開始] → 投票開始
├── [日程調整を開始] → 日程調整作成 (/liff/wishes/[id]/schedule)
└── [削除] → 削除確認

日程調整作成 (/liff/wishes/[id]/schedule)
├── カレンダーで日付選択
├── 締め切り設定（任意）
└── [日程調整を開始] → 投票開始 + LINE通知

日程調整投票 (/liff/wishes/[id]/schedule/vote)
├── 各日付に6択で回答
├── 回答状況テーブル表示
└── [回答を保存] → 保存

参加確認 (/liff/wishes/[id]/confirm)
├── 予定情報表示
├── ◯△×で回答
├── 回答状況（グループ化表示）
└── [回答を保存] → 保存

設定 (/liff/settings)
├── プロフィール表示
├── グループ通知設定
│   ├── 開始通知 ON/OFF
│   ├── リマインド ON/OFF
│   └── 確定通知 ON/OFF
└── おすすめ提案設定
    ├── ON/OFF
    ├── 頻度（2週/1ヶ月/2ヶ月）
    └── 条件（2人/3人/5人以上）
```

---

## 状態遷移 (wish)

```
                    ┌─────────────────────────────────────┐
                    │                                     │
                    ▼                                     │
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  作成   │───▶│  open   │───▶│ voting  │───▶│confirmed│
│         │    │         │    │         │    │         │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
                    │              │
                    │              │
           日程なし │    日程あり  │
           興味あり │ voting_started│
           のみ     │    = true    │
                    │              │
                    ▼              ▼
              日程調整開始    参加確認開始
              (status=voting) (voting_started=true)
```

### 状態の意味

| status | voting_started | start_date | 状態 |
|--------|----------------|------------|------|
| open | false | null | 行きたいのみ（日程未定） |
| open | false | あり | 日程あり、参加確認未開始 |
| open | true | あり | 参加確認中 |
| voting | - | null | 日程調整中 |
| confirmed | - | あり | 日程確定 |

---

## 通知フロー

```
日程調整開始
    │
    ├── 即時: 📅 開始通知
    │
    ├── 締切3日前: ⏰ リマインド (Cron)
    │
    └── 締切後: 📊 結果通知 (未実装)


参加確認開始
    │
    ├── 即時: ✅ 開始通知
    │
    └── 締切前日: ⏰ リマインド (Cron)


日程確定
    │
    └── 即時: 🎉 確定通知


定期提案 (Cron)
    │
    └── 設定間隔ごと: 🎯 おすすめ提案
```

---

## コンポーネント構成

### ホーム (LiffContent.tsx)
```
LiffContent
├── Header
│   ├── アプリ名
│   ├── グループ名 (タップでボトムシート)
│   └── プロフィール画像
├── BottomSheet (グループ選択)
├── Section: 回答が必要
├── Section: 直近の予定
├── Section: 人気の行きたい
├── Section: クイックアクション
└── BottomNav
```

### 行きたいリスト (WishesContent.tsx)
```
WishesContent
├── Header
├── NewButton (FAB)
├── WishList
│   └── WishCard
│       ├── タイトル + 人数
│       ├── 日時情報
│       ├── 締め切り
│       ├── 説明
│       └── アクションボタン
└── BottomNav
```

### 日程調整投票 (VoteContent.tsx)
```
VoteContent
├── Header
├── CandidateList
│   └── CandidateCard
│       ├── 日付
│       └── 6ボタン (◯/×/未定/午前/午後/夜)
├── ResponseTable
│   └── 名前 × 日付 のマトリクス
├── SaveButton (fixed)
└── BottomNav
```

### 参加確認 (ConfirmContent.tsx)
```
ConfirmContent
├── Header
├── EventInfo
│   ├── タイトル
│   ├── 日時
│   └── 締め切り
├── MyResponse
│   └── 3ボタン (◯参加/△未定/×不参加)
├── ResponseStatus
│   ├── ◯参加リスト
│   ├── △未定リスト
│   ├── ×不参加リスト
│   └── 未回答リスト
├── SaveButton (fixed)
└── BottomNav
```

---

## 通知メッセージテンプレート

### 日程調整開始
```
📅 日程調整が始まりました！

「焼肉」

▼ 回答はこちら
https://liff.line.me/xxx/wishes/xxx/schedule/vote?groupId=xxx
```

### 参加確認開始
```
✅ 参加確認が始まりました！

「焼肉」
📅 2/15(土) 18:00

▼ 回答はこちら
https://liff.line.me/xxx/wishes/xxx/confirm?groupId=xxx
```

### リマインド
```
⏰ 日程調整の締め切りが近づいています！

「焼肉」
あと3日で締め切り

▼ まだの方は回答を
https://liff.line.me/xxx/wishes/xxx/schedule/vote?groupId=xxx
```

### 日程確定
```
🎉 日程が決定しました！

「焼肉」
📅 2/15(土)

楽しみにしてね！
```

### おすすめ提案
```
🎯 そろそろ遊びませんか？

人気の行きたいリスト:
・「焼肉」5人が興味あり
・「カラオケ」4人が興味あり
・「映画」3人が興味あり

▼ 日程調整を始める
https://liff.line.me/xxx/wishes?groupId=xxx
```

---

## セキュリティ考慮

### 認証
- LIFF SDKでLINEログイン
- LINE User IDでユーザー識別
- グループメンバーのみアクセス可能

### API
- Cron APIは `CRON_SECRET` で認証
- Webhook署名検証（未実装、推奨）

### データ
- グループ内データはそのグループメンバーのみ参照可能
- 他グループのデータは見えない

---

## パフォーマンス考慮

### 楽観的更新
- 興味ありボタン、投票ボタンは即時UI反映
- バックグラウンドでAPI呼び出し

### debounce
- 日程調整投票は300ms debounce後に保存

### キャッシュ
- 現状なし（必要に応じてSWR等導入検討）

---

## 既知の制限

1. **グループ名**: Bot参加時 or メッセージ送信時にのみ取得
2. **通知**: グループ全員に送信（個人別ON/OFFなし）
3. **日程確定**: 手動確定フローが未実装
4. **編集**: 行きたいの編集機能なし（削除のみ）
5. **履歴**: 過去の予定のアーカイブ機能なし
